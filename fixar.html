<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fixar - a minimalist bookmark manager</title>

<!-- Bootstrap 5 CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f8f9fa;
  --bg-tertiary: #e9ecef;
  --text-primary: #212529;
  --text-secondary: #6c757d;
  --text-muted: #adb5bd;
  --border-color: #dee2e6;
  --hover-bg: #f8f9fa;
  --shadow-sm: 0 0.125rem 0.25rem rgba(0,0,0,0.05);
  --shadow-md: 0 0.5rem 1rem rgba(0,0,0,0.08);
  --folder-bg: #f0f4f8;
}

body {
  background-color: var(--bg-secondary);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  color: var(--text-primary);
}

.navbar-brand {
  font-weight: 600;
  letter-spacing: -0.5px;
}

.folder-card {
  background: var(--folder-bg);
  border: 2px dashed var(--border-color);
  border-radius: 0.5rem;
  padding: 1rem;
  margin-bottom: 1rem;
  transition: all 0.3s ease;
}

.folder-card.drag-over {
  background: var(--bg-tertiary);
  border-color: var(--text-secondary);
  border-style: solid;
  box-shadow: var(--shadow-md);
}

.folder-header {
  cursor: pointer;
  user-select: none;
  padding: 0.5rem;
  background: var(--bg-primary);
  border-radius: 0.375rem;
  margin-bottom: 0.75rem;
}

.folder-header:hover {
  background: var(--bg-secondary);
}

.folder-title {
  font-weight: 600;
  font-size: 1rem;
  color: var(--text-primary);
}

.folder-content {
  transition: all 0.3s ease;
}

.folder-badge {
  background: var(--text-muted);
  color: white;
  font-size: 0.75rem;
  padding: 0.2rem 0.5rem;
  border-radius: 0.25rem;
}

.container-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
  cursor: move;
  min-height: 250px;
}

.container-card:hover {
  box-shadow: var(--shadow-md);
}

.container-card.collapsed {
  min-height: auto;
}

.container-card.dragging {
  opacity: 0.5;
  transform: rotate(2deg);
}

.container-card.drag-over {
  transform: scale(1.05);
  box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
}

.container-header {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  cursor: move;
}

.container-title {
  font-size: 0.9rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-primary);
}

.bookmark-item {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  transition: all 0.2s ease;
  cursor: move;
}

.bookmark-item:hover {
  background: var(--hover-bg);
  transform: translateX(4px);
  box-shadow: var(--shadow-sm);
}

.bookmark-link {
  color: var(--text-primary);
  text-decoration: none;
  font-size: 0.9rem;
}

.bookmark-link:hover {
  color: var(--text-secondary);
}

.tag-badge {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  font-size: 0.75rem;
  padding: 0.15rem 0.4rem;
}

.btn-minimal {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  font-size: 0.875rem;
  padding: 0.375rem 0.75rem;
  transition: all 0.2s ease;
}

.btn-minimal:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border-color: var(--text-secondary);
}

.btn-toolbar-action {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  font-size: 0.8rem;
  padding: 0.25rem 0.5rem;
  transition: all 0.2s ease;
}

.btn-toolbar-action:hover {
  background: var(--text-primary);
  color: white;
  border-color: var(--text-primary);
}

.dropdown-menu {
  border: 1px solid var(--border-color);
  box-shadow: var(--shadow-md);
  padding: 0.25rem;
}

.dropdown-item {
  border-radius: 0.25rem;
  font-size: 0.875rem;
  padding: 0.5rem 0.75rem;
}

.dropdown-item:hover {
  background: var(--bg-secondary);
}

.drag-handle {
  color: var(--text-muted);
  cursor: move;
  font-size: 1rem;
}

.drag-handle:hover {
  color: var(--text-secondary);
}

.dragging {
  opacity: 0.5;
}

.drag-over {
  border-top: 2px solid var(--text-secondary);
}

.search-input {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  font-size: 0.9rem;
}

.search-input:focus {
  background: var(--bg-primary);
  border-color: var(--text-secondary);
  box-shadow: none;
}

.color-input {
  width: 24px;
  height: 24px;
  padding: 0;
  border: 1px solid var(--border-color);
  border-radius: 0.25rem;
  cursor: pointer;
}

.chevron-icon {
  transition: transform 0.3s ease;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.chevron-icon.collapsed {
  transform: rotate(-90deg);
}

.container-content {
  overflow: hidden;
}

.btn-add {
  background: var(--bg-secondary);
  border: 1px dashed var(--border-color);
  color: var(--text-secondary);
  width: 100%;
  font-size: 0.875rem;
  padding: 0.5rem;
  transition: all 0.2s ease;
}

.btn-add:hover {
  background: var(--bg-primary);
  border-style: solid;
  color: var(--text-primary);
}

.bookmark-actions {
  opacity: 0;
  transition: opacity 0.2s ease;
}

.bookmark-item:hover .bookmark-actions {
  opacity: 1;
}

.create-folder-hint {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,123,255,0.9);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.875rem;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.container-card.drag-over .create-folder-hint {
  opacity: 1;
}

@media (max-width: 768px) {
  .container-card {
    min-height: 200px;
  }
  
  .bookmark-actions {
    opacity: 1;
  }
}
</style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-light bg-white border-bottom mb-4">
  <div class="container-fluid px-4">
    <span class="navbar-brand mb-0 h1">
      <i class="bi bi-bookmarks me-2"></i>Fixar
    </span>
    <div class="d-flex gap-2">
      <div class="btn-group btn-group-sm">
        <button class="btn btn-toolbar-action" onclick="expandAll()" title="Expand all">
          <i class="bi bi-arrows-expand"></i>
        </button>
        <button class="btn btn-toolbar-action" onclick="collapseAll()" title="Collapse all">
          <i class="bi bi-arrows-collapse"></i>
        </button>
      </div>
      <div class="vr"></div>
      <button class="btn btn-minimal" onclick="exportData()">
        <i class="bi bi-download me-1"></i>Export
      </button>
      <input type="file" id="importFile" accept=".json,.html" style="display:none" onchange="importData(event)">
      <button class="btn btn-minimal" onclick="document.getElementById('importFile').click()">
        <i class="bi bi-upload me-1"></i>Import
      </button>
    </div>
  </div>
</nav>

<!-- Main Container -->
<div class="container-fluid px-4">
  <!-- Controls -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="input-group">
        <span class="input-group-text bg-white border-end-0">
          <i class="bi bi-search text-muted"></i>
        </span>
        <input type="text" class="form-control search-input border-start-0" id="search" placeholder="Search bookmarks...">
      </div>
    </div>
    <div class="col-md-5">
      <div class="input-group">
        <input type="text" class="form-control search-input" id="containerName" placeholder="New container name">
        <input type="color" class="color-input ms-2" id="containerColor" value="#f8f9fa">
        <button class="btn btn-minimal ms-2" onclick="addContainer()">
          <i class="bi bi-plus-lg me-1"></i>Add Container
        </button>
      </div>
    </div>
  </div>

  <!-- Folders and Containers -->
  <div id="folders"></div>
  
  <!-- Standalone Containers Grid -->
  <div class="row g-3" id="containers"></div>
</div>

<!-- Footer -->
<footer class="mt-5 py-4 border-top bg-white">
  <div class="container-fluid px-4">
    <div class="row align-items-center">
      <div class="col-md-6">
        <p class="text-muted mb-0 small">
          <strong>Fixar</strong> - A minimal bookmark manager with folder organization
        </p>
        <p class="text-muted mb-0 small">
          Â© 2025 devnalua@gmail.com | v.1.0.0 | MIT License | <a href="https://github.com/jorge-brizio/fixar" class="text-decoration-none text-muted">GitHub</a>
        </p>
      </div>
      <div class="col-md-6 text-md-end">
        <p class="text-muted mb-0 small">
          Made with <i class="bi bi-heart-fill text-danger"></i> using Bootstrap & GSAP
        </p>
      </div>
    </div>
  </div>
</footer>

<!-- Add/Edit Bookmark Modal -->
<div class="modal fade" id="bookmarkModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="bookmarkModalLabel">Add Bookmark</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label small text-muted">Name</label>
          <input type="text" class="form-control search-input" id="modalBookmarkName" placeholder="Bookmark name">
        </div>
        <div class="mb-3">
          <label class="form-label small text-muted">URL</label>
          <input type="url" class="form-control search-input" id="modalBookmarkUrl" placeholder="https://example.com">
        </div>
        <div class="mb-3">
          <label class="form-label small text-muted">Tags</label>
          <input type="text" class="form-control search-input" id="modalBookmarkTags" placeholder="Comma separated">
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-minimal" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-dark" onclick="saveBookmark()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- GreenSock GSAP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<script>
// Data structure now supports folders
let data = {
  containers: {},
  folders: {}
};

// Load sample data or from localStorage
function loadData() {
  try {
    const stored = localStorage.getItem('bookmarksData');
    if (stored) {
      const parsed = JSON.parse(stored);
      // Migrate old format to new format
      if (!parsed.hasOwnProperty('containers') && !parsed.hasOwnProperty('folders')) {
        data = { containers: parsed, folders: {} };
      } else {
        data = parsed;
      }
    } else {
      // Sample data
      data = {
        containers: {
          "Sample Container": {
            color: "#f8f9fa",
            collapsed: false,
            items: [
              { name: "Google", url: "https://google.com", tags: ["search", "tools"], date: Date.now() },
              { name: "GitHub", url: "https://github.com", tags: ["development", "code"], date: Date.now() }
            ]
          }
        },
        folders: {}
      };
    }
  } catch(e) {
    console.log("Using default data");
    data = { containers: {}, folders: {} };
  }
}

loadData();

// Current editing context
let currentEditContext = null;
let draggedContainer = null;
let draggedOverContainer = null;

// Save data
function save() {
  try {
    localStorage.setItem('bookmarksData', JSON.stringify(data));
  } catch(e) {
    console.log("Could not save to localStorage");
  }
}

// Render everything
function render() {
  renderFolders();
  renderContainers();
  initializeDragAndDrop();
}

// Render folders
function renderFolders() {
  const foldersDiv = document.getElementById('folders');
  foldersDiv.innerHTML = '';
  
  Object.keys(data.folders).forEach((folderName, folderIndex) => {
    const folder = data.folders[folderName];
    const folderId = folderName.replace(/[^a-zA-Z0-9]/g, '_');
    
    const folderDiv = document.createElement('div');
    folderDiv.className = 'folder-card';
    folderDiv.setAttribute('data-folder', folderName);
    
    folderDiv.innerHTML = `
      <div class="folder-header d-flex align-items-center justify-content-between" onclick="toggleFolder('${folderName}')">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-chevron-${folder.collapsed ? 'right' : 'down'} chevron-icon"></i>
          <i class="bi bi-folder${folder.collapsed ? '' : '-open'} me-2"></i>
          <span class="folder-title">${folderName}</span>
          <span class="folder-badge">${Object.keys(folder.containers).length}</span>
        </div>
        <div class="dropdown" onclick="event.stopPropagation();">
          <button class="btn btn-sm p-1" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-three-dots-vertical text-muted"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="#" onclick="renameFolderPrompt('${folderName}'); return false;">
                <i class="bi bi-pencil me-2"></i>Rename Folder
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="#" onclick="unfoldAll('${folderName}'); return false;">
                <i class="bi bi-box-arrow-up me-2"></i>Ungroup All
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item text-danger" href="#" onclick="deleteFolder('${folderName}'); return false;">
                <i class="bi bi-trash me-2"></i>Delete Folder
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="folder-content ${folder.collapsed ? 'd-none' : ''}" id="folder-content-${folderId}">
        <div class="row g-3 mt-1"></div>
      </div>
    `;
    
    foldersDiv.appendChild(folderDiv);
    
    // Render containers within folder
    if (!folder.collapsed) {
      const folderContentRow = folderDiv.querySelector('.row');
      Object.keys(folder.containers).forEach((containerName, index) => {
        const containerCol = createContainerElement(containerName, folder.containers[containerName], folderName);
        folderContentRow.appendChild(containerCol);
        
        // Animate
        gsap.from(containerCol, {
          duration: 0.3,
          y: 10,
          opacity: 0,
          delay: index * 0.03,
          ease: "power2.out"
        });
      });
    }
    
    // Animate folder
    gsap.from(folderDiv, {
      duration: 0.4,
      y: 20,
      opacity: 0,
      delay: folderIndex * 0.05,
      ease: "power2.out"
    });
  });
}

// Render standalone containers
function renderContainers() {
  const containersDiv = document.getElementById('containers');
  const searchTerm = document.getElementById('search').value.toLowerCase().trim();
  containersDiv.innerHTML = '';
  
  const standaloneContainers = Object.keys(data.containers);
  
  if (standaloneContainers.length === 0 && Object.keys(data.folders).length === 0) {
    containersDiv.innerHTML = `
      <div class="col-12">
        <div class="text-center py-5 text-muted">
          <i class="bi bi-inbox display-1"></i>
          <p class="mt-3">No containers yet. Create your first container above!</p>
          <p class="small">Tip: Drag containers onto each other to create folders!</p>
        </div>
      </div>
    `;
    return;
  }
  
  standaloneContainers.forEach((containerName, index) => {
    const containerCol = createContainerElement(containerName, data.containers[containerName], null);
    containersDiv.appendChild(containerCol);
    
    // Animate
    gsap.from(containerCol, {
      duration: 0.4,
      y: 20,
      opacity: 0,
      delay: index * 0.05,
      ease: "power2.out"
    });
  });
}

// Create container element
function createContainerElement(containerName, containerData, parentFolder) {
  const searchTerm = document.getElementById('search').value.toLowerCase().trim();
  const sanitizedId = containerName.replace(/[^a-zA-Z0-9]/g, '_');
  const isCollapsed = containerData.collapsed || false;
  
  // Filter bookmarks
  const filteredBookmarks = containerData.items.filter(bm => 
    !searchTerm || 
    bm.name.toLowerCase().includes(searchTerm) ||
    bm.url.toLowerCase().includes(searchTerm) ||
    (bm.tags || []).some(t => t.toLowerCase().includes(searchTerm))
  );
  
  if (searchTerm && filteredBookmarks.length === 0) return document.createElement('div');
  
  const col = document.createElement('div');
  col.className = 'col-lg-3 col-md-4 col-sm-6';
  col.innerHTML = `
    <div class="card container-card ${isCollapsed ? 'collapsed' : ''}" 
         data-container="${containerName}" 
         data-folder="${parentFolder || ''}"
         style="border-left: 4px solid ${containerData.color || '#f8f9fa'};">
      <div class="create-folder-hint">
        <i class="bi bi-folder-plus me-1"></i>Create folder
      </div>
      <div class="container-header p-2 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-chevron-right chevron-icon ${isCollapsed ? 'collapsed' : ''}" 
             onclick="toggleContainer('${containerName}', '${parentFolder || ''}')" style="cursor: pointer;"></i>
          <span class="container-title">${containerName}</span>
        </div>
        <div class="dropdown">
          <button class="btn btn-sm p-1" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-three-dots-vertical text-muted"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="#" onclick="editContainerName('${containerName}', '${parentFolder || ''}'); return false;">
                <i class="bi bi-pencil me-2"></i>Rename
              </a>
            </li>
            <li>
              <div class="dropdown-item d-flex align-items-center">
                <i class="bi bi-palette me-2"></i>
                <span class="me-2">Color</span>
                <input type="color" class="color-input ms-auto" value="${containerData.color || '#f8f9fa'}" 
                       onchange="changeContainerColor('${containerName}', this.value, '${parentFolder || ''}')">
              </div>
            </li>
            ${parentFolder ? `
            <li>
              <a class="dropdown-item" href="#" onclick="moveToRoot('${containerName}', '${parentFolder}'); return false;">
                <i class="bi bi-box-arrow-up me-2"></i>Move out of folder
              </a>
            </li>
            ` : ''}
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item text-danger" href="#" onclick="deleteContainer('${containerName}', '${parentFolder || ''}'); return false;">
                <i class="bi bi-trash me-2"></i>Delete
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="container-content ${isCollapsed ? 'd-none' : ''}" id="content-${sanitizedId}">
        <div class="card-body p-2">
          <select class="form-select form-select-sm mb-2 search-input" onchange="sortBookmarks('${containerName}', this.value, '${parentFolder || ''}')">
            <option value="date">Newest first</option>
            <option value="name">A-Z</option>
          </select>
          <div class="bookmark-list" id="list-${sanitizedId}">
            ${filteredBookmarks.map((bm, i) => `
              <div class="bookmark-item rounded p-2 mb-2 d-flex align-items-center" data-index="${i}">
                <i class="bi bi-grip-vertical drag-handle me-2"></i>
                <img src="https://www.google.com/s2/favicons?domain=${new URL(bm.url).hostname}" 
                     width="16" height="16" class="me-2" onerror="this.style.display='none'">
                <div class="flex-grow-1 overflow-hidden">
                  <a href="${bm.url}" target="_blank" class="bookmark-link">${bm.name}</a>
                  <div class="mt-1">
                    ${(bm.tags || []).map(tag => `<span class="badge tag-badge me-1">${tag}</span>`).join('')}
                  </div>
                </div>
                <div class="bookmark-actions ms-2">
                  <button class="btn btn-sm p-1" onclick="editBookmark('${containerName}', ${i}, '${parentFolder || ''}')">
                    <i class="bi bi-pencil text-muted"></i>
                  </button>
                  <button class="btn btn-sm p-1" onclick="deleteBookmark('${containerName}', ${i}, '${parentFolder || ''}')">
                    <i class="bi bi-x-lg text-muted"></i>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
          <button class="btn btn-add mt-2" onclick="showAddBookmark('${containerName}', '${parentFolder || ''}')">
            <i class="bi bi-plus me-1"></i>Add Bookmark
          </button>
        </div>
      </div>
    </div>
  `;
  
  return col;
}

// Initialize drag and drop
function initializeDragAndDrop() {
  // Container dragging
  document.querySelectorAll('.container-card').forEach(container => {
    const header = container.querySelector('.container-header');
    
    header.draggable = true;
    
    header.addEventListener('dragstart', (e) => {
      draggedContainer = {
        name: container.dataset.container,
        folder: container.dataset.folder || null
      };
      container.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    
    header.addEventListener('dragend', () => {
      container.classList.remove('dragging');
      draggedContainer = null;
      draggedOverContainer = null;
      // Remove all drag-over states
      document.querySelectorAll('.drag-over').forEach(el => {
        el.classList.remove('drag-over');
      });
    });
    
    // Allow dropping on containers to create folders
    container.addEventListener('dragover', (e) => {
      e.preventDefault();
      if (draggedContainer && draggedContainer.name !== container.dataset.container) {
        container.classList.add('drag-over');
        draggedOverContainer = {
          name: container.dataset.container,
          folder: container.dataset.folder || null
        };
      }
    });
    
    container.addEventListener('dragleave', () => {
      container.classList.remove('drag-over');
    });
    
    container.addEventListener('drop', (e) => {
      e.preventDefault();
      container.classList.remove('drag-over');
      
      if (draggedContainer && draggedOverContainer && 
          draggedContainer.name !== draggedOverContainer.name) {
        createFolderFromContainers(draggedContainer, draggedOverContainer);
      }
    });
  });
}

// Create folder from two containers
function createFolderFromContainers(dragged, droppedOn) {
  const folderName = prompt('Enter folder name:', 'New Folder');
  if (!folderName) return;
  
  // Get the containers
  let draggedData, droppedData;
  
  if (dragged.folder) {
    draggedData = data.folders[dragged.folder].containers[dragged.name];
    delete data.folders[dragged.folder].containers[dragged.name];
    // Clean up empty folder
    if (Object.keys(data.folders[dragged.folder].containers).length === 0) {
      delete data.folders[dragged.folder];
    }
  } else {
    draggedData = data.containers[dragged.name];
    delete data.containers[dragged.name];
  }
  
  if (droppedOn.folder) {
    droppedData = data.folders[droppedOn.folder].containers[droppedOn.name];
    delete data.folders[droppedOn.folder].containers[droppedOn.name];
    // Clean up empty folder
    if (Object.keys(data.folders[droppedOn.folder].containers).length === 0) {
      delete data.folders[droppedOn.folder];
    }
  } else {
    droppedData = data.containers[droppedOn.name];
    delete data.containers[droppedOn.name];
  }
  
  // Create new folder
  if (!data.folders[folderName]) {
    data.folders[folderName] = {
      collapsed: false,
      containers: {}
    };
  }
  
  data.folders[folderName].containers[dragged.name] = draggedData;
  data.folders[folderName].containers[droppedOn.name] = droppedData;
  
  save();
  render();
  
  // Animate the new folder
  const newFolder = document.querySelector(`[data-folder="${folderName}"]`);
  if (newFolder) {
    gsap.from(newFolder, {
      duration: 0.5,
      scale: 0.9,
      opacity: 0,
      ease: "back.out(1.7)"
    });
  }
}

// Toggle folder
function toggleFolder(folderName) {
  data.folders[folderName].collapsed = !data.folders[folderName].collapsed;
  save();
  
  const folderId = folderName.replace(/[^a-zA-Z0-9]/g, '_');
  const content = document.getElementById(`folder-content-${folderId}`);
  const chevron = document.querySelector(`[data-folder="${folderName}"] .chevron-icon`);
  const folderIcon = document.querySelector(`[data-folder="${folderName}"] .bi-folder, [data-folder="${folderName}"] .bi-folder-open`);
  
  if (data.folders[folderName].collapsed) {
    gsap.to(content, {
      duration: 0.3,
      height: 0,
      opacity: 0,
      ease: "power2.inOut",
      onComplete: () => {
        content.classList.add('d-none');
      }
    });
    chevron.classList.remove('bi-chevron-down');
    chevron.classList.add('bi-chevron-right');
    folderIcon.classList.remove('bi-folder-open');
    folderIcon.classList.add('bi-folder');
  } else {
    content.classList.remove('d-none');
    render(); // Re-render to show containers
    gsap.from(content, {
      duration: 0.3,
      height: 0,
      opacity: 0,
      ease: "power2.inOut"
    });
    chevron.classList.remove('bi-chevron-right');
    chevron.classList.add('bi-chevron-down');
    folderIcon.classList.remove('bi-folder');
    folderIcon.classList.add('bi-folder-open');
  }
}

// Rename folder
function renameFolderPrompt(oldName) {
  const newName = prompt('New folder name:', oldName);
  if (newName && newName !== oldName) {
    data.folders[newName] = data.folders[oldName];
    delete data.folders[oldName];
    save();
    render();
  }
}

// Delete folder
function deleteFolder(folderName) {
  if (confirm(`Delete folder "${folderName}"? Containers will be moved to root.`)) {
    // Move all containers to root
    Object.keys(data.folders[folderName].containers).forEach(containerName => {
      data.containers[containerName] = data.folders[folderName].containers[containerName];
    });
    delete data.folders[folderName];
    save();
    render();
  }
}

// Unfold all containers from a folder
function unfoldAll(folderName) {
  Object.keys(data.folders[folderName].containers).forEach(containerName => {
    data.containers[containerName] = data.folders[folderName].containers[containerName];
  });
  delete data.folders[folderName];
  save();
  render();
}

// Move container to root
function moveToRoot(containerName, folderName) {
  data.containers[containerName] = data.folders[folderName].containers[containerName];
  delete data.folders[folderName].containers[containerName];
  
  // Clean up empty folder
  if (Object.keys(data.folders[folderName].containers).length === 0) {
    delete data.folders[folderName];
  }
  
  save();
  render();
}

// Expand all containers
function expandAll() {
  // Expand all standalone containers
  Object.keys(data.containers).forEach(name => {
    data.containers[name].collapsed = false;
  });
  
  // Expand all folders and their containers
  Object.keys(data.folders).forEach(folderName => {
    data.folders[folderName].collapsed = false;
    Object.keys(data.folders[folderName].containers).forEach(containerName => {
      data.folders[folderName].containers[containerName].collapsed = false;
    });
  });
  
  save();
  render();
}

// Collapse all containers
function collapseAll() {
  // Collapse all standalone containers
  Object.keys(data.containers).forEach(name => {
    data.containers[name].collapsed = true;
  });
  
  // Collapse all folders and their containers
  Object.keys(data.folders).forEach(folderName => {
    data.folders[folderName].collapsed = true;
    Object.keys(data.folders[folderName].containers).forEach(containerName => {
      data.folders[folderName].containers[containerName].collapsed = true;
    });
  });
  
  save();
  render();
}

// Toggle container collapse
function toggleContainer(containerName, parentFolder) {
  const container = parentFolder ? 
    data.folders[parentFolder].containers[containerName] : 
    data.containers[containerName];
  
  container.collapsed = !container.collapsed;
  save();
  
  const sanitizedId = containerName.replace(/[^a-zA-Z0-9]/g, '_');
  const content = document.getElementById(`content-${sanitizedId}`);
  const chevron = document.querySelector(`[data-container="${containerName}"] .chevron-icon`);
  const card = document.querySelector(`[data-container="${containerName}"]`);
  
  if (container.collapsed) {
    gsap.to(content, {
      duration: 0.3,
      height: 0,
      opacity: 0,
      ease: "power2.inOut",
      onComplete: () => {
        content.classList.add('d-none');
        card.classList.add('collapsed');
      }
    });
    chevron.classList.add('collapsed');
  } else {
    content.classList.remove('d-none');
    card.classList.remove('collapsed');
    gsap.from(content, {
      duration: 0.3,
      height: 0,
      opacity: 0,
      ease: "power2.inOut"
    });
    chevron.classList.remove('collapsed');
  }
}

// Container functions
function addContainer() {
  const name = document.getElementById('containerName').value.trim();
  const color = document.getElementById('containerColor').value;
  
  if (!name) {
    alert('Please enter a container name');
    return;
  }
  
  if (data.containers[name]) {
    alert('Container already exists');
    return;
  }
  
  data.containers[name] = { color: color, collapsed: false, items: [] };
  save();
  render();
  
  document.getElementById('containerName').value = '';
}

function deleteContainer(name, parentFolder) {
  if (confirm(`Delete "${name}" and all its bookmarks?`)) {
    if (parentFolder) {
      delete data.folders[parentFolder].containers[name];
      // Clean up empty folder
      if (Object.keys(data.folders[parentFolder].containers).length === 0) {
        delete data.folders[parentFolder];
      }
    } else {
      delete data.containers[name];
    }
    save();
    render();
  }
}

function editContainerName(container, parentFolder) {
  const newName = prompt("New name:", container);
  if (newName && newName !== container) {
    const containerData = parentFolder ? 
      data.folders[parentFolder].containers[container] : 
      data.containers[container];
    
    if (parentFolder) {
      data.folders[parentFolder].containers[newName] = containerData;
      delete data.folders[parentFolder].containers[container];
    } else {
      data.containers[newName] = containerData;
      delete data.containers[container];
    }
    
    save();
    render();
  }
}

function changeContainerColor(container, color, parentFolder) {
  if (parentFolder) {
    data.folders[parentFolder].containers[container].color = color;
  } else {
    data.containers[container].color = color;
  }
  save();
  
  const card = document.querySelector(`[data-container="${container}"]`);
  if (card) {
    gsap.to(card, {
      duration: 0.3,
      borderLeftColor: color,
      ease: "power2.inOut"
    });
  }
}

// Bookmark functions
function showAddBookmark(container, parentFolder) {
  currentEditContext = { container, parentFolder, isNew: true };
  document.getElementById('bookmarkModalLabel').textContent = 'Add Bookmark';
  document.getElementById('modalBookmarkName').value = '';
  document.getElementById('modalBookmarkUrl').value = '';
  document.getElementById('modalBookmarkTags').value = '';
  new bootstrap.Modal(document.getElementById('bookmarkModal')).show();
}

function editBookmark(container, index, parentFolder) {
  const containerData = parentFolder ? 
    data.folders[parentFolder].containers[container] : 
    data.containers[container];
  const bookmark = containerData.items[index];
  
  currentEditContext = { container, parentFolder, index, isNew: false };
  document.getElementById('bookmarkModalLabel').textContent = 'Edit Bookmark';
  document.getElementById('modalBookmarkName').value = bookmark.name;
  document.getElementById('modalBookmarkUrl').value = bookmark.url;
  document.getElementById('modalBookmarkTags').value = (bookmark.tags || []).join(', ');
  new bootstrap.Modal(document.getElementById('bookmarkModal')).show();
}

function saveBookmark() {
  if (!currentEditContext) return;
  
  const name = document.getElementById('modalBookmarkName').value.trim();
  let url = document.getElementById('modalBookmarkUrl').value.trim();
  const tags = document.getElementById('modalBookmarkTags').value.split(',').map(t => t.trim()).filter(t => t);
  
  if (!url) {
    alert('URL is required');
    return;
  }
  
  if (!url.match(/^https?:\/\//)) {
    url = 'https://' + url;
  }
  
  const bookmarkData = {
    name: name || new URL(url).hostname,
    url: url,
    tags: tags,
    date: Date.now()
  };
  
  const containerData = currentEditContext.parentFolder ? 
    data.folders[currentEditContext.parentFolder].containers[currentEditContext.container] : 
    data.containers[currentEditContext.container];
  
  if (currentEditContext.isNew) {
    containerData.items.push(bookmarkData);
  } else {
    containerData.items[currentEditContext.index] = bookmarkData;
  }
  
  save();
  render();
  bootstrap.Modal.getInstance(document.getElementById('bookmarkModal')).hide();
}

function deleteBookmark(container, index, parentFolder) {
  if (confirm('Delete this bookmark?')) {
    if (parentFolder) {
      data.folders[parentFolder].containers[container].items.splice(index, 1);
    } else {
      data.containers[container].items.splice(index, 1);
    }
    save();
    render();
  }
}

function sortBookmarks(container, method, parentFolder) {
  const containerData = parentFolder ? 
    data.folders[parentFolder].containers[container] : 
    data.containers[container];
  
  if (method === 'name') {
    containerData.items.sort((a, b) => a.name.localeCompare(b.name));
  } else {
    containerData.items.sort((a, b) => b.date - a.date);
  }
  save();
  render();
}

// Import/Export
function exportData() {
  const dataStr = JSON.stringify(data, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `bookmarks_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    if (file.name.endsWith('.html') || content.trim().startsWith('<!DOCTYPE')) {
      importHTMLBookmarks(content);
    } else {
      importJSONBookmarks(content);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function importJSONBookmarks(content) {
  try {
    const imported = JSON.parse(content);
    
    // Handle old format (direct containers) or new format (with folders)
    if (!imported.hasOwnProperty('containers') && !imported.hasOwnProperty('folders')) {
      // Old format - convert to new
      if (confirm('Import bookmarks from older version?')) {
        data = { containers: imported, folders: {} };
        save();
        render();
      }
    } else {
      // New format
      if (confirm('Replace all bookmarks and folders?')) {
        data = imported;
        save();
        render();
      }
    }
  } catch(err) {
    alert('Invalid JSON file');
  }
}

function importHTMLBookmarks(content) {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(content, 'text/html');
    const links = doc.querySelectorAll('a[href]');
    
    data.containers['Imported'] = {
      color: '#f8f9fa',
      collapsed: false,
      items: []
    };
    
    links.forEach(link => {
      if (link.href && !link.href.startsWith('javascript:')) {
        data.containers['Imported'].items.push({
          name: link.textContent.trim(),
          url: link.href,
          tags: [],
          date: Date.now()
        });
      }
    });
    
    if (confirm(`Import ${data.containers['Imported'].items.length} bookmarks?`)) {
      save();
      render();
    }
  } catch(err) {
    alert('Error importing HTML file');
  }
}

// Search
document.getElementById('search').addEventListener('input', render);

// Initial render
render();
</script>

</body>
</html>